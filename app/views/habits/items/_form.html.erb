<%= turbo_frame_tag 'habits_item_form' do %>
  <% current_list = @item.list || current_user.default_list %>
  <% if @item.errors.any? %>
    <div class="rounded-md bg-red-50 p-4">
      <div class="flex">
        <div class="shrink">
          <!-- Heroicon name: mini/x-circle -->
          <svg class="h-5 w-5 text-red-400" aria-hidden="true" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 10-1.06-1.06L10 8.94 8.28 7.22z" />
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-red-800">
            There were <%= @item.errors.count %> errors with your submission
          </h3>
          <div class="mt-2 text-sm text-red-700">
            <ul class="list-disc space-y-1 pl-5" role="list">
              <% @item.errors.full_messages.each do |msg| %>
                <li><%= msg %></li>
              <% end %>
            </ul>
          </div>
        </div>
      </div>
    </div>
  <% end %>
  <%= form_with(model: @item, url: @item.new_record? ? habits_list_items_path(current_list) : habits_list_item_path(current_list, @item), method: @item.new_record? ? :post : :patch) do |f| %>
    <div class="space-y-6">
      <!-- Name -->
      <div>
        <%= f.label :name, "Habit Name", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.text_field :name, required: true,
            class: "w-full rounded-lg border border-gray-300 px-4 py-2 text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition" %>
      </div>

      <!-- Habit List -->
      <div data-controller="tom-select" data-tom-select-mode-value="single">
        <%= f.label :list_id, "Habit List", class: "text-left tracking-normal text-gray-700 text-base leading-tight" %>
        <%= f.select :list_id, options_from_collection_for_select(all_habits_lists_for_dropdown, :id, :name, current_list.id), {}, class: "w-full form-select rounded-md mt-3", data: { tom_select_target: 'select' }%>
      </div>

      <div x-data="{ frequency: '<%= @item.frequency %>', selectedDays: <%= @item.selected_days %> }" class="space-y-6">
        <!-- Frequency Dropdown -->
        <div>
          <%= f.label :frequency, "Frequency", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= f.select :frequency, Habits::Item.frequencies.keys.map { |k| [k.titleize, k] }, {}, class: "w-full rounded-lg border border-gray-300 bg-white px-4 py-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition", "x-model" => "frequency" %>
        </div>

        <!-- Custom Days Selection -->
        <div x-show="frequency === 'custom'" class="space-y-2 transition-all duration-200">
          <label class="block text-sm font-medium text-gray-700 mb-1">Select Days</label>

          <div class="flex flex-wrap gap-2">
            <% Habits::Item::DAYS.each do |day| %>
              <button
                type="button"
                x-on:click="selectedDays.includes('<%= day %>') ? selectedDays = selectedDays.filter(d => d !== '<%= day %>') : selectedDays.push('<%= day %>')"
                x-bind:class="selectedDays.includes('<%= day %>') ? 'bg-primary-600 text-white' : 'bg-gray-100 text-gray-800 hover:bg-gray-200'"
                class="px-3 py-1 rounded-full text-sm font-medium transition">
                <%= day.titleize %>
              </button>
            <% end %>
          </div>
          
          <!-- Hidden field to store days -->
          <input type="hidden" name="habits_item[custom_days]" x-bind:value="selectedDays.join(',')" />
        </div>
      </div>

      <!-- Tags -->
      <div data-controller="tom-select">
        <%= f.label :tag_ids, "Tags", class: "text-left tracking-normal text-gray-700 text-base leading-tight" %>
        <%= f.select :tag_ids,
              options_for_select(tag_options_for_user, @item.tag_ids),
              {},
              multiple: true,
              class: "w-full form-select rounded-md mt-3",
              data: { tom_select_target: 'select' } %>
        <p class="mt-1 text-xs text-gray-500">Select one or more tags that describe this habit.</p>
      </div>


      <!-- Target (Optional) -->
      <div>
        <%= f.label :target_value, "Target Value (optional)", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.number_field :target_value, class: "w-full rounded-lg border border-gray-300 px-4 py-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition" %>
      </div>

      <!-- Submit -->
      <div>
        <%= f.submit @item.new_record? ? "Create Habit" : "Update Habit", class: "w-full px-4 py-2 bg-primary-600 text-white font-semibold rounded-lg shadow hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 transition cursor-pointer", data: { turbo_submits_with: "Submitting..." } %>
      </div>
    </div>
  <% end %>
<% end %>
 